<!DOCTYPE html>












  




<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">

<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css">

  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #999999; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>


<meta name="theme-color" content="#222">













<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">





  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "68e741bb"
    });
  daovoice('update');
  </script>














  
  
    
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.css" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.lug.ustc.edu.cn/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.5.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.5.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.5.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.5.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.5.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="Mysql服务器的默认端口是3306。 MyISAM和InnoDB区别两者的对比：  是否支持行级锁 : MyISAM 只有表级锁(table-level locking)，而InnoDB 支持行级锁(row-level locking)和表级锁,默认为行级锁。 是否支持事务和崩溃后的安全恢复： MyISAM 强调的是性能，每次查询具有原子性,其执行速度比InnoDB类型更快，但是不提供事务支持。">
<meta property="og:type" content="article">
<meta property="og:title" content="Mysql回顾">
<meta property="og:url" content="http://yoursite.com/2020/03/13/Mysql回顾/index.html">
<meta property="og:site_name" content="liuminggui&#39;s home">
<meta property="og:description" content="Mysql服务器的默认端口是3306。 MyISAM和InnoDB区别两者的对比：  是否支持行级锁 : MyISAM 只有表级锁(table-level locking)，而InnoDB 支持行级锁(row-level locking)和表级锁,默认为行级锁。 是否支持事务和崩溃后的安全恢复： MyISAM 强调的是性能，每次查询具有原子性,其执行速度比InnoDB类型更快，但是不提供事务支持。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://github.com/hac135/my_images/blob/master/2020_03_13.1.png?raw=true">
<meta property="og:image" content="https://raw.githubusercontent.com/hac135/my_images/master/20210315_mysql_rowLock.png">
<meta property="og:image" content="https://github.com/hac135/my_images/blob/master/20200727_gaplock.jpg?raw=true">
<meta property="og:image" content="https://raw.githubusercontent.com/hac135/my_images/master/20210315_mysql_vertical.png">
<meta property="og:image" content="https://raw.githubusercontent.com/hac135/my_images/master/20210315_mysql_horizal.png">
<meta property="og:image" content="https://raw.githubusercontent.com/hac135/my_images/master/20210315_mysql_Btree.png">
<meta property="og:image" content="https://raw.githubusercontent.com/hac135/my_images/master/20210315_mysql_B%2Btree.png">
<meta property="og:image" content="https://raw.githubusercontent.com/hac135/my_images/master/20210321_MySQL_%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95table.png">
<meta property="og:image" content="https://raw.githubusercontent.com/hac135/my_images/master/20210321_MySQL_%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="https://raw.githubusercontent.com/hac135/my_images/master/20210321_MySQL_%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95%E6%9F%A5%E6%89%BE.png">
<meta property="og:image" content="https://raw.githubusercontent.com/hac135/my_images/master/20210321_MySQL_%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95_%E6%9C%80%E5%B7%A6%E5%8C%B9%E9%85%8D1.png">
<meta property="og:image" content="https://github.com/hac135/my_images/blob/master/20200519_%E7%AC%AC%E4%B8%80%E8%8C%83%E5%BC%8F.png?raw=true">
<meta property="og:image" content="https://github.com/hac135/my_images/blob/master/20200519_%E7%AC%AC%E4%BA%8C%E8%8C%83%E5%BC%8F.png?raw=true">
<meta property="og:image" content="https://github.com/hac135/my_images/blob/master/20200519_%E7%AC%AC%E4%B8%89%E8%8C%83%E5%BC%8F.png?raw=true">
<meta property="og:image" content="https://github.com/hac135/my_images/blob/master/%E8%BF%9E%E6%8E%A5.png?raw=true">
<meta property="og:image" content="https://github.com/hac135/my_images/blob/master/%E8%87%AA%E7%84%B6%E8%BF%9E%E6%8E%A5.png?raw=true">
<meta property="og:image" content="https://github.com/hac135/my_images/blob/master/%E5%86%85%E8%BF%9E%E6%8E%A5.png?raw=true">
<meta property="og:image" content="https://github.com/hac135/my_images/blob/master/%E5%B7%A6%E5%A4%96%E8%BF%9E%E6%8E%A5.png?raw=true">
<meta property="og:image" content="https://github.com/hac135/my_images/blob/master/%E5%8F%B3%E5%A4%96%E8%BF%9E%E6%8E%A5.png?raw=true">
<meta property="og:image" content="https://github.com/hac135/my_images/blob/master/%E5%85%A8%E5%A4%96%E8%BF%9E%E6%8E%A5.png?raw=true">
<meta property="og:image" content="https://raw.githubusercontent.com/hac135/my_images/master/20210319_DataStructure_MySQL_masterSlave.jpg">
<meta property="og:updated_time" content="2021-03-22T13:16:47.355Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mysql回顾">
<meta name="twitter:description" content="Mysql服务器的默认端口是3306。 MyISAM和InnoDB区别两者的对比：  是否支持行级锁 : MyISAM 只有表级锁(table-level locking)，而InnoDB 支持行级锁(row-level locking)和表级锁,默认为行级锁。 是否支持事务和崩溃后的安全恢复： MyISAM 强调的是性能，每次查询具有原子性,其执行速度比InnoDB类型更快，但是不提供事务支持。">
<meta name="twitter:image" content="https://github.com/hac135/my_images/blob/master/2020_03_13.1.png?raw=true">






  <link rel="canonical" href="http://yoursite.com/2020/03/13/Mysql回顾/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Mysql回顾 | liuminggui's home</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>



  </head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>

<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>

  
  
    
  
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">liuminggui's home</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-photos">

    
    
    
      
    

    

    <a href="/photos" rel="section"><i class="menu-item-icon fa fa-fw fa-image"></i> <br>相册</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/13/Mysql回顾/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="liuminggui">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/mycat.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="liuminggui's home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Mysql回顾
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-03-13 11:44:04" itemprop="dateCreated datePublished" datetime="2020-03-13T11:44:04+08:00">2020-03-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-03-22 21:16:47" itemprop="dateModified" datetime="2021-03-22T21:16:47+08:00">2021-03-22</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>Mysql服务器的默认端口是3306。</strong></p>
<h4 id="MyISAM和InnoDB区别"><a href="#MyISAM和InnoDB区别" class="headerlink" title="MyISAM和InnoDB区别"></a>MyISAM和InnoDB区别</h4><p><strong>两者的对比：</strong></p>
<ol>
<li><strong>是否支持行级锁</strong> : MyISAM 只有表级锁(table-level locking)，而InnoDB 支持行级锁(row-level locking)和表级锁,默认为行级锁。</li>
<li><strong>是否支持事务和崩溃后的安全恢复： MyISAM</strong> 强调的是性能，每次查询具有原子性,其执行速度比InnoDB类型更快，但是不提供事务支持。但是<strong>InnoDB</strong> 提供事务支持事务，外部键等高级数据库功能。 具有事务(commit)、回滚(rollback)和崩溃修复能力(crash recovery capabilities)的事务安全(transaction-safe (ACID compliant))型表。</li>
<li><strong>是否支持外键：</strong> MyISAM不支持，而InnoDB支持。</li>
<li><strong>是否支持MVCC</strong> ：仅 InnoDB 支持。应对高并发事务, MVCC比单纯的加锁更高效;MVCC只在 <code>READ COMMITTED</code> 和 <code>REPEATABLE READ</code> 两个隔离级别下工作;MVCC可以使用 乐观(optimistic)锁 和 悲观(pessimistic)锁来实现;各数据库中MVCC实现并不统一。</li>
</ol>
<blockquote>
<p>外键：外键用于与另一张表的关联，用于保持数据一致性。外键必须是Unique或者主键。</p>
<p>多版本并发控制（Multi-Version Concurrency Control, MVCC），顾名思义，在并发访问的时候，数据存在版本的概念，可以有效地提升数据库并发能力，常见的数据库如MySQL、MS SQL Server、IBM DB2、Hbase、MongoDB等等都在使用。<br> 简单讲，如果没有MVCC，当想要读取的数据被其他事务用排它锁锁住时，只能互斥等待；而这时MVCC可以通过提供历史版本从而实现读取被锁的数据(的历史版本)，避免了互斥等待。</p>
<p>在 MySQL中，多版本并发控制是 的 InnoDB 存储引擎实现隔离级别的一种具体方式，用于实现提交读和可重复读这两种隔离级别。而未提交读隔离级别总是读取最新的数据行，无需使用 MVCC；可串行化隔离级别需要对所有读取的行都加锁，单纯使用 MVCC 无法实现。</p>
</blockquote>
<p>事务**：指的是满足 ACID 特性的一组操作，可以通过 Commit 提交一个事务，也可以使用 Rollback 进行回滚。</p>
<p>ACID</p>
<p>1.<strong>原子性</strong>（Atomicity）要么都成功，要么都失败,即<strong>事务是最小单位</strong>，不允许切割</p>
<p>eg: A账户给B账户转账，A扣100元钱，B增加100元钱</p>
<p>2.<strong>一致性</strong>（Consistency）</p>
<p>数据库在事务执行前后都保持一致性状态。在一致性状态下，所有事务对同一个数据的读取结果都是相同的。</p>
<p>3.<strong>隔离性</strong>（Isolation）</p>
<p>一个事务所做的修改在最终提交以前，对其它事务是不可见的。</p>
<p>4.<strong>持久性</strong>（Durability）</p>
<p>一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。</p>
<p>并发事务带来的问题：</p>
<p>1.<strong>脏读</strong></p>
<p>T1 修改一个数据，T2 随后读取这个数据。如果 T1 撤销了这次修改，那么 T2 读取的数据是脏数据。</p>
<p>2.<strong>丢失修改</strong></p>
<p>T1，T2,读取到某数据20，T1修改20-1，T2修改20-1，最终19，T1修改被丢失。</p>
<p>3.<strong>不可重复读</strong></p>
<p>T2 读取一个数据，T1 对该数据做了修改。如果 T2 再次读取这个数据，此时读取的结果和第一次读取的结果不同。</p>
<p>4.<strong>幻读</strong></p>
<p>同不可重复读一样，T2可能增加了几行，T1蒙蔽了，出现了幻觉。</p>
<p>事务的隔离级别</p>
<p>1.<strong>READ-UNCOMMITTED(读取未提交)：</strong> 最低的隔离级别，允许读取尚未提交的数据变更，可能会导致脏读、幻读或不可重复读。</p>
<p><strong>2.READ-COMMITTED(读取已提交)： </strong>允许读取并发事务已经提交的数据，可以<strong>阻止脏读</strong>，但是幻读或不可重复读仍有可能发生。<em>**</em>（先读一次，别人提交，再读一次，不一样我擦，不可重复读）</p>
<p>3.<strong>REPEATABLE-READ(可重复读)：</strong> 对同一字段的多次读取结果都是一致的，除非数据是被本身事务自己所修改，可以<strong>阻止脏读和不可重复读</strong>，但幻读仍有可能发生。（读的时候加锁，别人就改不了了，可自己可能会改）</p>
<p>explain:在可重复读中，该sql第一次读取到数据后，就将这些数据加锁（悲观锁），其它事务无法修改这些数据，就可以实现可重复读了。但这种方法却<strong>无法锁住insert</strong>的数据，所以当事务A先前读取了数据，或者修改了全部数据，事务B还是可以insert数据提交，这时事务A就会发现莫名其妙多了一条之前没有的数据，这就是幻读，不能通过行锁来避免。需要Serializable隔离级别 ，读用读锁，写用写锁，读锁和写锁互斥，这么做可以有效的避免幻读、不可重复读、脏读等问题，但会极大的降低数据库的并发能力。</p>
<p><strong>其实并不是加锁，而是利用MVCC.</strong></p>
<p>MySQL默认的隔离级别是可重复读，即：事务A在读到一条数据之后，此时事务B对该数据进行了修改并提交，那么事务A再读该数据，读到的还是原来的内容。 那么MySQL可重复读是如何实现的呢？MVCC</p>
<p>4.<strong>SERIALIZABLE(可串行化)：</strong> 最高的隔离级别，完全服从ACID的隔离级别。所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰，也就是说，该级别可以防止脏读、不可重复读以及幻读。</p>
<p><img src="https://github.com/hac135/my_images/blob/master/2020_03_13.1.png?raw=true" alt=""></p>
<p>MySQL InnoDB 存储引擎的<strong>默认</strong>支持的隔离级别是 <strong>REPEATABLE-READ（可重读）</strong></p>
<blockquote>
<p>与 SQL 标准不同的地方在于 InnoDB 存储引擎在 <strong>REPEATABLE-READ（可重读）</strong> 事务隔离级别下使用的是Next-Key Lock 锁算法，因此可以避免幻读的产生。因为隔离级别越低，事务请求的锁越少，所以大部分数据库系统的隔离级别都是 <strong>READ-COMMITTED(读取提交内容)</strong> ，但是你要知道的是InnoDB 存储引擎默认使用 <strong>REPEAaTABLE-READ（可重读）</strong> 并不会有任何性能损失。</p>
<p>InnoDB 存储引擎在 <strong>分布式事务</strong> 的情况下一般会用到 <strong>SERIALIZABLE(可串行化)</strong> 隔离级别。</p>
</blockquote>
<h3 id="锁机制与InnoDB锁算法"><a href="#锁机制与InnoDB锁算法" class="headerlink" title="锁机制与InnoDB锁算法"></a>锁机制与InnoDB锁算法</h3><p><strong>MyISAM和InnoDB存储引擎使用的锁：</strong></p>
<ul>
<li>MyISAM采用表级锁(table-level locking)。</li>
<li>InnoDB支持行级锁(row-level locking)和表级锁,默认为行级锁 </li>
</ul>
<p><strong>表级锁和行级锁对比：</strong></p>
<ul>
<li><strong>表级锁：</strong> MySQL中锁定 <strong>粒度最大</strong> 的一种锁，对当前操作的整张表加锁，实现简单，资源消耗也比较少，加锁快，<strong>不会出现死锁</strong>。其锁定粒度最大，触发锁冲突的概率最高，并发度最低，MyISAM和 InnoDB引擎都支持表级锁。</li>
<li><strong>行级锁：</strong> MySQL中锁定 <strong>粒度最小</strong> 的一种锁，只针对当前操作的行进行加锁。 行级锁能大大减少数据库操作的冲突。其加锁粒度最小，并发度高，但加锁的开销也最大，加锁慢，<strong>会出现死锁</strong>（why?，如图所示）。</li>
</ul>
<p><img src="https://raw.githubusercontent.com/hac135/my_images/master/20210315_mysql_rowLock.png" alt="deadLock"></p>
<p>表锁不会发生这种情况，因为表锁是一次性获取所有表的锁，才开始事务。</p>
<h4 id="记录锁（Record-Lock）"><a href="#记录锁（Record-Lock）" class="headerlink" title="记录锁（Record Lock）"></a>记录锁（Record Lock）</h4><p>事务加锁后锁住的只是表的某一条记录。</p>
<p><strong>记录锁出现条件：</strong>精准条件命中，并且命中的条件字段是唯一索引；</p>
<p><strong>例如：</strong>update user_info set name=’张三’ where id=1 ,这里的id是唯一索引。</p>
<p><strong>记录锁的作用：</strong>加了记录锁之后可以避免数据在查询的时候被修改的重复读问题，也避免了在修改的事务未提交前被其他事务读取的脏读问题。</p>
<h4 id="间隙锁（Gap-Lock）"><a href="#间隙锁（Gap-Lock）" class="headerlink" title="间隙锁（Gap Lock）"></a>间隙锁（Gap Lock）</h4><p><strong>间隙锁出现的条件：</strong>范围查询并且查询未命中记录，查询条件必须命中索引、间隙锁只会出现在REPEATABLE_READ（重复读)的事务级别中。</p>
<p><strong>例如</strong>：对应上图的表执行select * from user_info where id&gt;1 and id&lt;4(这里的id是唯一索引) ，这个SQL查询不到对应的记录，那么此时会使用间隙锁。</p>
<p><strong>间隙锁作用？</strong></p>
<p>防止幻读问题，事务并发的时候，如果没有间隙锁，就会发生如下图的问题，在同一个事务里，A事务的两次查询出的结果会不一样。</p>
<p><img src="https://github.com/hac135/my_images/blob/master/20200727_gaplock.jpg?raw=true" alt=""></p>
<h4 id="Next-Key-Lock"><a href="#Next-Key-Lock" class="headerlink" title="Next-Key Lock"></a>Next-Key Lock</h4><p>临键锁是INNODB的行锁默认算法，它是记录锁和间隙锁的组合，临键锁会把查询出来的记录锁住，同时也会把该范围查询内的所有间隙空间也会锁住，再之它会把相邻的下一个区间也会锁住。</p>
<p><strong>出现条件：</strong>范围查询并命中，查询命中了索引。</p>
<p><strong>临键锁的作用</strong></p>
<p>结合记录锁和间隙锁的特性，临键锁避免了在范围查询时出现脏读、重复读、幻读问题。加了临键锁之后，在范围区间内数据不允许被修改和插入。</p>
<h3 id="大表优化"><a href="#大表优化" class="headerlink" title="大表优化"></a>大表优化</h3><p>当MySQL单表记录数过大时，数据库的CRUD性能会明显下降，一些常见的优化措施如下：</p>
<h4 id="1-限定数据的范围"><a href="#1-限定数据的范围" class="headerlink" title="1. 限定数据的范围"></a>1. 限定数据的范围</h4><p>务必禁止不带任何限制数据范围条件的查询语句。比如：我们当用户在查询订单历史的时候，我们可以控制在一个月的范围内；</p>
<h4 id="2-读-写分离"><a href="#2-读-写分离" class="headerlink" title="2. 读/写分离"></a>2. 读/写分离</h4><p>经典的数据库拆分方案，主库负责写，从库负责读；</p>
<h4 id="3-垂直分区"><a href="#3-垂直分区" class="headerlink" title="3. 垂直分区"></a>3. 垂直分区</h4><p><strong>根据数据库里面数据表的相关性进行拆分。</strong> 例如，用户表中既有用户的登录信息又有用户的基本信息，可以将用户表拆分成两个单独的表，甚至放到单独的库做分库。</p>
<p><strong>简单来说垂直拆分是指数据表列的拆分，把一张列比较多的表拆分为多张表。</strong> 如下图所示，这样来说大家应该就更容易理解了。</p>
<p><img src="https://raw.githubusercontent.com/hac135/my_images/master/20210315_mysql_vertical.png" alt="vertical"></p>
<ul>
<li><p><strong>垂直拆分的优点：</strong> 可以使得列数据变小，在查询时减少读取的Block数，减少I/O次数。此外，垂直分区可以简化表的结构，易于维护。</p>
</li>
<li><p><strong>垂直拆分的缺点：</strong> 主键会出现冗余，需要管理冗余列，并会引起Join操作，可以通过在应用层进行Join来解决。此外，垂直分区会让事务变得更加复杂；</p>
<p>[</p>
</li>
</ul>
<h4 id="4-水平分区"><a href="#4-水平分区" class="headerlink" title="4. 水平分区"></a>4. 水平分区</h4><p><strong>保持数据表结构不变，通过某种策略存储数据分片。这样每一片数据分散到不同的表或者库中，达到了分布式的目的。 水平拆分可以支撑非常大的数据量。</strong></p>
<p>水平拆分是指数据表行的拆分，表的行数超过200万行时，就会变慢，这时可以把一张的表的数据拆成多张表来存放。举个例子：我们可以将用户信息表拆分成多个用户信息表，这样就可以避免单一表数据量过大对性能造成影响。</p>
<p><img src="https://raw.githubusercontent.com/hac135/my_images/master/20210315_mysql_horizal.png" alt="horizon"></p>
<p>水平拆分可以支持非常大的数据量。需要注意的一点是：分表仅仅是解决了单一表数据过大的问题，但由于表的数据还是在同一台机器上，其实对于提升MySQL并发能力没有什么意义，所以 <strong>水平拆分最好分库</strong> 。</p>
<h3 id="分库分表之后-id-主键如何处理？"><a href="#分库分表之后-id-主键如何处理？" class="headerlink" title="分库分表之后,id 主键如何处理？"></a>分库分表之后,id 主键如何处理？</h3><p>因为要是分成多个表之后，每个表都是从 1 开始累加，这样是不对的，我们需要一个全局唯一的 id 来支持。</p>
<p>生成全局 id 有下面这几种方式：</p>
<ul>
<li><p><strong>UUID UUID比较长，是无序的。</strong></p>
</li>
<li><p><strong>Twitter的snowflake算法（雪花算法）</strong> ：</p>
<p> SnowFlake算法生成id的结果是一个64bit大小的整数。所有生成的id按时间趋势递增整个分布式系统内不会产生重复id</p>
</li>
<li><p><strong>美团的Leaf分布式ID生成系统</strong> ：</p>
</li>
</ul>
<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><h2 id="Mysql索引主要使用的两种数据结构"><a href="#Mysql索引主要使用的两种数据结构" class="headerlink" title="Mysql索引主要使用的两种数据结构"></a>Mysql索引主要使用的两种数据结构</h2><ul>
<li><h3 id="哈希索引-O-1"><a href="#哈希索引-O-1" class="headerlink" title="哈希索引  O(1)"></a>哈希索引  O(1)</h3></li>
</ul>
<p><strong>不适合范围查询。</strong>如SELECT * FROM tb1 WHERE id &lt; 500，查500次？</p>
<p>InnoDB不支持哈希索引</p>
<p>对于哈希索引来说，底层的数据结构就是哈希表，因此在绝大多数需求为<strong>单条记录</strong>查询的时候，可以选择哈希索引，查询性能最快；其余大部分场景，建议选择BTree索引。</p>
<ul>
<li><h3 id="BTree索引-和-B-Tree索引"><a href="#BTree索引-和-B-Tree索引" class="headerlink" title="BTree索引  和 B+Tree索引"></a>BTree索引  和 <strong>B+Tree索引</strong></h3></li>
</ul>
<p><strong>1.B树的所有节点既存放 键(key) 也存放 数据(data);而B+树只有叶子节点存放 key 和 data，其他内节点只存放key。（只针对聚集索引，如主键索引。不然data可能存放的是数据的指针或主键）</strong></p>
<p><strong>2.B树的叶子节点都是独立的;B+树的叶子节点有一条引用链指向与它相邻的叶子节点。</strong></p>
<p>3.B树的检索的过程相当于对范围内的每个节点的关键字做二分查找，可能还没有到达叶子节点，检索就结束了。而B+树的检索效率就很稳定了，任何查找都是从根节点到叶子节点的过程，叶子节点的顺序检索很明显（大大提升<strong>范围查询</strong>的效率）。</p>
<p><img src="https://raw.githubusercontent.com/hac135/my_images/master/20210315_mysql_Btree.png" alt="Btree" style="zoom:150%;"></p>
<p>PS：每个节点占用一个盘块的磁盘空间，一个节点上有两个升序排序的关键字和三个指向子树根节点的指针，指针存储的是子节点所在磁盘块的地址。</p>
<p><img src="https://raw.githubusercontent.com/hac135/my_images/master/20210315_mysql_B%2Btree.png" alt="B+树" style="zoom:150%;"></p>
<p>PS：B树结构图中可以看到每个节点不仅包含数据的key值，还有data值。而每一个页的存储空间是有限的，如果data数据较大时将会导致每个节点（即一个页）能存储的key的数量很小，当存储的数据量很大时同样会导致B树的深度增大，增大查询时的I/O次数进而影响查询效率。</p>
<p><strong>备注：</strong>B+树的高度在2-3层左右。也就意味着只需要2-3次的IO操作即可。</p>
<h4 id="面试官：为什么MySQL的索引要使用B-树，而不是其它树？比如B树？"><a href="#面试官：为什么MySQL的索引要使用B-树，而不是其它树？比如B树？" class="headerlink" title="面试官：为什么MySQL的索引要使用B+树，而不是其它树？比如B树？"></a>面试官：为什么MySQL的索引要使用B+树，而不是其它树？比如B树？</h4><p>1、B+<strong>树的层级更少</strong>：相较于B树B+每个<strong>非叶子</strong>节点存储的关键字数更多，树的层级更少所以查询数据更快；</p>
<p>2、B+<strong>树查询速度更稳定</strong>：B+所有关键字数据地址都存在<strong>叶子</strong>节点上，所以每次查找的次数都相同所以查询速度要比B树更稳定;</p>
<p>3、B+<strong>树天然具备排序功能：</strong>B+树所有的<strong>叶子</strong>节点数据构成了一个有序链表，在查询大小区间的数据时候更方便，数据紧密性很高，缓存的命中率也会比B树高。</p>
<p>4、B+<strong>树全节点遍历更快：</strong>B+树遍历整棵树只需要遍历所有的<strong>叶子</strong>节点即可，，而不需要像B树一样需要对每一层进行遍历，这有利于数据库做全表扫描。</p>
<p><strong>B树</strong>相对于<strong>B+树</strong>的优点是，如果经常访问的数据离根节点很近，而<strong>B树</strong>的<strong>非叶子</strong>节点本身存有关键字其数据的地址，所以这种数据检索的时候会要比<strong>B+树</strong>快。</p>
<h2 id="聚集索引与非聚集索引"><a href="#聚集索引与非聚集索引" class="headerlink" title="聚集索引与非聚集索引"></a>聚集索引与非聚集索引</h2><h3 id="聚集索引"><a href="#聚集索引" class="headerlink" title="聚集索引"></a>聚集索引</h3><p><strong>聚集索引即索引结构和数据一起存放的索引。主键索引属于聚集索引。</strong></p>
<p>在 Mysql 中，InnoDB引擎的表的 <code>.ibd</code>文件就包含了该表的索引和数据，对于 InnoDB 引擎表来说，该表的索引(B+树)的每个非叶子节点存储索引，叶子节点存储索引和索引对应的数据。</p>
<h4 id="聚集索引的优点"><a href="#聚集索引的优点" class="headerlink" title="聚集索引的优点"></a>聚集索引的优点</h4><p>聚集索引的查询速度非常的快，因为整个B+树本身就是一颗多叉平衡树，叶子节点也都是有序的，定位到索引的节点，就相当于定位到了数据。</p>
<h4 id="聚集索引的缺点"><a href="#聚集索引的缺点" class="headerlink" title="聚集索引的缺点"></a>聚集索引的缺点</h4><ol>
<li><strong>依赖于有序的数据</strong> ：因为B+树是多路平衡树，如果索引的数据不是有序的，那么就需要在插入时排序，如果数据是整型还好，否则类似于字符串或UUID这种又长又难比较的数据，插入或查找的速度肯定比较慢。</li>
<li><strong>更新代价大</strong> ： 如果对索引列的数据被修改时，那么对应的索引也将会被修改， 而且况聚集索引的叶子节点还存放着数据，修改代价肯定是较大的， 所以对于主键索引来说，主键一般都是不可被修改的。</li>
</ol>
<h3 id="非聚集索引"><a href="#非聚集索引" class="headerlink" title="非聚集索引"></a>非聚集索引</h3><p><strong>非聚集索引即索引结构和数据分开存放的索引。</strong></p>
<p><strong>二级索引属于非聚集索引。</strong></p>
<blockquote>
<p>MYISAM引擎的表的.MYI文件包含了表的索引， 该表的索引(B+树)的每个叶子非叶子节点存储索引， 叶子节点存储索引和索引对应数据的指针，指向.MYD文件的数据。</p>
</blockquote>
<p><strong>非聚集索引的叶子节点并不一定存放数据的指针， 因为二级索引的叶子节点就存放的是主键，根据主键再回表查数据。</strong></p>
<h4 id="非聚集索引的优点"><a href="#非聚集索引的优点" class="headerlink" title="非聚集索引的优点"></a>非聚集索引的优点</h4><p><strong>更新代价比聚集索引要小</strong> 。非聚集索引的更新代价就没有聚集索引那么大了，非聚集索引的叶子节点是不存放数据的</p>
<h4 id="非聚集索引的缺点"><a href="#非聚集索引的缺点" class="headerlink" title="非聚集索引的缺点"></a>非聚集索引的缺点</h4><ol>
<li>跟聚集索引一样，非聚集索引也依赖于有序的数据</li>
<li><strong>可能会二次查询(回表)</strong> :这应该是非聚集索引最大的缺点了。 当查到索引对应的指针或主键后，可能还需要根据指针或主键再到数据文件或表中查询。</li>
</ol>
<h3 id="非聚集索引一定回表查询吗-覆盖索引"><a href="#非聚集索引一定回表查询吗-覆盖索引" class="headerlink" title="非聚集索引一定回表查询吗(覆盖索引)?"></a>非聚集索引一定回表查询吗(覆盖索引)?</h3><p><strong>非聚集索引不一定回表查询。</strong></p>
<blockquote>
<p>试想一种情况，用户准备使用SQL查询用户名，而用户名字段正好建立了索引。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT name FROM table WHERE username=&apos;guang19&apos;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>那么这个索引的key本身就是name，查到对应的name直接返回就行了，无需回表查询。</p>
</blockquote>
<p><strong>即使是MYISAM也是这样，虽然MYISAM的主键索引确实需要回表， 因为它的主键索引的叶子节点存放的是指针。但是如果SQL查的就是主键呢?</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT id FROM table WHERE id=1;</span><br></pre></td></tr></table></figure>
<p>主键索引本身的key就是主键，查到返回就行了。这种情况就称之为覆盖索引了。</p>
<h2 id="覆盖索引介绍"><a href="#覆盖索引介绍" class="headerlink" title="覆盖索引介绍"></a>覆盖索引介绍</h2><h3 id="什么是覆盖索引"><a href="#什么是覆盖索引" class="headerlink" title="什么是覆盖索引"></a>什么是覆盖索引</h3><p>如果一个索引包含（或者说覆盖）所有需要查询的字段的值，我们就称之为“覆盖索引”。我们知道InnoDB存储引擎中，如果不是主键索引，叶子节点存储的是主键+列值。最终还是要“回表”，也就是要通过主键再查找一次。这样就会比较慢覆盖索引就是把要查询出的列和索引是对应的，不做回表操作！</p>
<h3 id="覆盖索引使用实例"><a href="#覆盖索引使用实例" class="headerlink" title="覆盖索引使用实例"></a>覆盖索引使用实例</h3><p>现在我创建了索引(username,age)，我们执行下面的 sql 语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> username , age <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> username = <span class="string">'Java'</span> <span class="keyword">and</span> age = <span class="number">22</span></span><br></pre></td></tr></table></figure>
<p>在查询数据的时候：要查询出的列在叶子节点都存在！所以，就不用回表。</p>
<h2 id="联合索引最左前缀匹配原则"><a href="#联合索引最左前缀匹配原则" class="headerlink" title="联合索引最左前缀匹配原则"></a>联合索引最左前缀匹配原则</h2><p>在MySQL建立联合索引时会遵循最左前缀匹配原则。</p>
<p>联合索引的有点</p>
<ul>
<li><p>减少开销</p>
<p>建一个联合索引(col1,col2,col3)，实际相当于建了(col1),(col1,col2),(col1,col2,col3)三个索引。每多一个索引，都会增加写操作的开销和磁盘空间的开销。对于大量数据的表，使用联合索引会大大的减少开销！</p>
</li>
<li><p>覆盖索引</p>
<p>对联合索引(col1,col2,col3)，如果有如下的sql: select col1,col2,col3 from test where col1=1 and col2=2。那么MySQL可以直接通过遍历索引取得数据，而无需回表，</p>
</li>
<li><p>效率高</p>
<p>对col1、col2、col3三列分别创建索引，MySQL只会选择辨识度高的一列作为索引。假设有100w的数据，一个索引筛选出10%的数据，那么可以筛选出10w的数据；对于联合索引而言，可以筛选出100w<em>10%</em>10%*10%=1000条数据。</p>
</li>
</ul>
<p>假设我们创建（col1，col2，col3）这样的一个组合索引，那么相当于对col1列进行排序，也就是我们创建组合索引，以最左边的为准，只要查询条件中带有最左边的列，那么查询就会使用到索引。</p>
<p>最频繁使用的列放在左边；查看列的选择性（即该列的索引值数量与记录数量的比值），比值越高，效果越好；</p>
<h3 id="联合索引"><a href="#联合索引" class="headerlink" title="联合索引"></a>联合索引</h3><p>表T1如图所示，有字段a,b,c,d,e，其中a是主键，联合索引（b，c，d）</p>
<p><img src="https://raw.githubusercontent.com/hac135/my_images/master/20210321_MySQL_%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95table.png" alt="联合索引table"></p>
<p>InnoDB会使用主键索引在B+树维护索引和数据文件，然后我们创建了一个<code>联合索引（b，c，d）</code>也会生成一个索引树，同样是B+树的结构，只不过它的data部分存储的是联合索引所在行的主键值（上图叶子节点紫色背景部分）。</p>
<p><img src="https://raw.githubusercontent.com/hac135/my_images/master/20210321_MySQL_%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84.png" alt="联合索引结构"></p>
<p>对于联合索引来说只不过比单值索引多了几列，而这些索引列全都出现在索引树上。对于联合索引，存储引擎会首先根据第一个索引列排序，如上图我们可以单看第一个索引列，横着看，如，<code>1 1 5 12 13</code>….他是单调递增的；如果第一列相等则再根据第二列排序，依次类推就构成了上图的索引树，上图中的b列都等于1时，则根据c排序，此时c列也相等则按d列排序，如：<code>1 1 4</code> ，<code>1 1 5</code>，c=4在c=5前面，以及<code>13 12 4</code>,<code>13 16 1</code>,<code>13 16 5</code>就可以说明这种情况。</p>
<p>当我们的SQL语言可以应用到索引的时候，比如<code>select * from T1 where b = 12 and c = 14 and d = 3;</code> 也就是T1表中a列为4的这条记录。存储引擎首先从根节点（一般常驻内存）开始查找，第一个索引的第一个索引列为1,12大于1，第二个索引的第一个索引列为56,12小于56，于是从这俩索引的中间读到下一个节点的磁盘文件地址，从磁盘上Load这个节点，通常伴随一次磁盘IO，然后在内存里去查找。当Load叶子节点的第二个节点时又是一次磁盘IO，比较第一个元素，b=12,c=14,d=3完全符合，于是找到该索引下的data元素即ID值，再从主键索引树上找到最终数据。</p>
<p><img src="https://raw.githubusercontent.com/hac135/my_images/master/20210321_MySQL_%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95%E6%9F%A5%E6%89%BE.png" alt="联合索引查找"></p>
<h3 id="最左匹配原则"><a href="#最左匹配原则" class="headerlink" title="最左匹配原则"></a>最左匹配原则</h3><p>之所以会有最左前缀匹配原则和联合索引的索引构建方式及存储结构是有关系的。</p>
<p>首先我们创建的<code>index_bcd(b,c,d)</code>索引，相当于创建了(b)、（b、c）（b、c、d）三个索引，看完下面你就知道为什么相当于创建了三个索引。</p>
<p>我们看，联合索引是首先使用多列索引的第一列构建的索引树，用上面idx_t1_bcd(b,c,d)的例子就是优先使用b列构建，当b列值相等时再以c列排序，若c列的值也相等则以d列排序。我们可以取出索引树的叶子节点看一下。</p>
<p><img src="https://raw.githubusercontent.com/hac135/my_images/master/20210321_MySQL_%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95_%E6%9C%80%E5%B7%A6%E5%8C%B9%E9%85%8D1.png" alt="最左匹配1"></p>
<p>索引的第一列也就是b列可以说是从左到右单调递增的，但我们看c列和d列并没有这个特性，它们只能在b列值相等的情况下这个小范围内递增，如第一叶子节点的第1、2个元素和第二个叶子节点的后三个元素。  由于联合索引是上述那样的索引构建方式及存储结构，所以联合索引只能从多列索引的第一列开始查找。所以如果你的查找条件不包含b列如（c,d）、(c）、(d)是无法应用缓存的，以及跨列也是无法完全用到索引如(b,d)，只会用到b列索引。</p>
<p>这就像我们的电话本一样，有名和姓以及电话，名和姓就是联合索引。在姓可以以姓的首字母排序，姓的首字母相同的情况下，再以名的首字母排序。</p>
<p>如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">M</span><br><span class="line">    毛 不易   178********</span><br><span class="line">    马 化腾   183********</span><br><span class="line">    马 云     188********</span><br><span class="line">Z</span><br><span class="line">    张 杰     189********</span><br><span class="line">    张 靓颖   138********</span><br><span class="line">    张 艺兴   176********</span><br></pre></td></tr></table></figure>
<p>我们知道名和姓是很快就能够从姓的首字母索引定位到姓，然后定位到名，进而找到电话号码，因为所有的姓从上到下按照既定的规则（首字母排序）是有序的，而名是在姓的首字母一定的条件下也是按照名的首字母排序的，但是整体来看，所有的名放在一起是无序的，所以如果只知道名查找起来就比较慢，因为无法用已排好的结构快速查找。</p>
<h2 id="MySQL查询优化"><a href="#MySQL查询优化" class="headerlink" title="MySQL查询优化"></a>MySQL查询优化</h2><h3 id="使用-Explain-进行分析"><a href="#使用-Explain-进行分析" class="headerlink" title="使用 Explain 进行分析"></a>使用 Explain 进行分析</h3><p>Explain 用来分析 SELECT 查询语句，开发人员可以通过分析 Explain 结果来优化查询语句。</p>
<p>比较重要的字段有：</p>
<ul>
<li><p>select_type : 查询类型，有简单查询、联合查询、子查询等</p>
</li>
<li><p>key : 使用的索引</p>
</li>
<li><p>rows : 扫描的行数</p>
</li>
</ul>
<h3 id="优化数据访问"><a href="#优化数据访问" class="headerlink" title="优化数据访问"></a>优化数据访问</h3><h4 id="1-减少请求的数据量"><a href="#1-减少请求的数据量" class="headerlink" title="1. 减少请求的数据量"></a>1. 减少请求的数据量</h4><ul>
<li>只返回必要的列：最好不要使用 SELECT * 语句。</li>
<li>只返回必要的行：使用 <strong>LIMIT</strong> 语句来限制返回的数据。</li>
<li><strong>缓存</strong>重复查询的数据：使用缓存可以避免在数据库中进行查询，特别在要查询的数据经常被重复查询时，缓存带来的查询性能提升将会是非常明显的。</li>
</ul>
<h4 id="2-减少服务器端扫描的行数"><a href="#2-减少服务器端扫描的行数" class="headerlink" title="2. 减少服务器端扫描的行数"></a>2. 减少服务器端扫描的行数</h4><p>最有效的方式是使用<strong>索引来覆盖查询</strong></p>
<h3 id="重构查询方式"><a href="#重构查询方式" class="headerlink" title="重构查询方式"></a>重构查询方式</h3><h4 id="1-切分大查询"><a href="#1-切分大查询" class="headerlink" title="1. 切分大查询"></a>1. 切分大查询</h4><p>一个大查询如果一次性执行的话，可能一次锁住很多数据、占满整个事务日志、耗尽系统资源、阻塞很多小的但重要的查询。</p>
<h4 id="2-分解大连接查询"><a href="#2-分解大连接查询" class="headerlink" title="2. 分解大连接查询"></a>2. 分解大连接查询</h4><p>将一个大连接查询分解成对每一个表进行一次单表查询</p>
<h2 id="数据库常问面试题"><a href="#数据库常问面试题" class="headerlink" title="数据库常问面试题"></a>数据库常问面试题</h2><h4 id="1-三大范式"><a href="#1-三大范式" class="headerlink" title="1.三大范式"></a>1.三大范式</h4><p><strong>第一范式（1NF）：要求数据库表的每一列都是不可分割的原子数据项。</strong></p>
<p><img src="https://github.com/hac135/my_images/blob/master/20200519_%E7%AC%AC%E4%B8%80%E8%8C%83%E5%BC%8F.png?raw=true" alt=""></p>
<p><strong>第二范式（2NF）：在1NF的基础上，非码属性必须完全依赖于候选码（在1NF基础上消除非主属性对主码的部分函数依赖）</strong></p>
<p><img src="https://github.com/hac135/my_images/blob/master/20200519_%E7%AC%AC%E4%BA%8C%E8%8C%83%E5%BC%8F.png?raw=true" alt=""></p>
<p><strong>第三范式（3NF）：在2NF基础上，任何非主属性不依赖于其它非主属性（在2NF基础上消除传递依赖）</strong></p>
<p><strong>第三范式需要确保数据表中的每一列数据都和主键直接相关，而不能间接相关。</strong></p>
<p><img src="https://github.com/hac135/my_images/blob/master/20200519_%E7%AC%AC%E4%B8%89%E8%8C%83%E5%BC%8F.png?raw=true" alt=""></p>
<h4 id="2-内连接-自然连接-外连接-笛卡尔连接"><a href="#2-内连接-自然连接-外连接-笛卡尔连接" class="headerlink" title="2.内连接 自然连接 外连接 笛卡尔连接"></a>2.内连接 自然连接 外连接 笛卡尔连接</h4><p>数据中的连接join分为内连接、自然连接、外连接，外连接又分为左外连接、右外连接、全外连接。</p>
<p>当然，这些分类都是在连接的基础上，是从两个表中记录的笛卡尔积中选取满足连接的记录。</p>
<p>有如下两个表</p>
<p><img src="https://github.com/hac135/my_images/blob/master/%E8%BF%9E%E6%8E%A5.png?raw=true" alt=""></p>
<p>他们的笛卡尔积如图。</p>
<p><strong>自然连接（natural join）</strong><br>自然连接是一种特殊的等值连接，他要求两个关系表中进行比较的必须是相同的属性列，无须添加连接条件，并且在结果中消除重复的属性列。<br>sql语句：Select …… from 表1 natural join 表2<br>结果：</p>
<p><img src="https://github.com/hac135/my_images/blob/master/%E8%87%AA%E7%84%B6%E8%BF%9E%E6%8E%A5.png?raw=true" alt=""></p>
<p><strong>内连接（inner join）</strong><br>内连接基本与自然连接相同，不同之处在于自然连接要求是同名属性列的比较，而内连接则不要求两属性列同名，可以用using或on来指定某两列字段相同的连接条件。<br>sql语句：Select …… from 表1 inner join 表 2 on 表1.A=表2.E</p>
<p>如果没有后面的on条件，内连接得到的就是笛卡尔积</p>
<p>结果：</p>
<p><img src="https://github.com/hac135/my_images/blob/master/%E5%86%85%E8%BF%9E%E6%8E%A5.png?raw=true" alt=""></p>
<p>自然连接时某些属性值不同则会导致这些元组会被舍弃，那如何保存这些会被丢失的信息呢，外连接就解决了相应的问题。外连接分为左外连接、右外连接、全外连接。外连接必须用using或on指定连接条件。</p>
<p><strong>左外连接（left outer join)</strong><br>左外连接是在两表进行自然连接，只把左表要舍弃的保留在结果集中，右表对应的列上填null。<br>sql语句：Select …… from 表1 left outer join 表2 on 表1.C=表2.C<br>结果：</p>
<p><img src="https://github.com/hac135/my_images/blob/master/%E5%B7%A6%E5%A4%96%E8%BF%9E%E6%8E%A5.png?raw=true" alt=""></p>
<p><strong>右外连接(rignt outer join)</strong><br>右外连接是在两表进行自然连接，只把右表要舍弃的保留在结果集中，左表对应的列上填null。<br>Select …… from 表1 rignt outer join 表2 on 表1.C=表2.C<br>结果：</p>
<p><img src="https://github.com/hac135/my_images/blob/master/%E5%8F%B3%E5%A4%96%E8%BF%9E%E6%8E%A5.png?raw=true" alt=""></p>
<p><strong>全外连接(full join)</strong><br>全外连接是在两表进行自然连接，只把左表和右表要舍弃的都保留在结果集中，相对应的列上填null。<br>Select …… from 表1 full join 表2 on 表1.C=表2.C<br>结果：</p>
<p><img src="https://github.com/hac135/my_images/blob/master/%E5%85%A8%E5%A4%96%E8%BF%9E%E6%8E%A5.png?raw=true" alt=""></p>
<h4 id="3-视图"><a href="#3-视图" class="headerlink" title="3.视图"></a>3.视图</h4><h4 id="4-CHAR和VARCHAR的区别"><a href="#4-CHAR和VARCHAR的区别" class="headerlink" title="4.CHAR和VARCHAR的区别"></a>4.CHAR和VARCHAR的区别</h4><p>CHAR：表示的是定长的字符串，当你输入小于指定的数目，比如你指定的数目是 <code>char(6)</code>，当你输入小于 6 个字符的时候，char 会在你最后一个字符后面补空值。当你输入超过指定允许最大长度后，MySQL 会报错</p>
<p>VARCHAR：varchar 指的是长度为 n 个字节的可变长度，并且是<code>非Unicode</code>的字符数据。n 的值是介于 1 - 8000 之间的数值。存储大小为实际大小。</p>
<p>使用 char 存储定长的数据非常方便、char 检索效率高，无论你存储的数据是否到了 10 个字节，都要去占用 10 字节的空间</p>
<p>使用 varchar 可以存储变长的数据，但存储效率没有 char 高。</p>
<h4 id="5-谈谈-SQL-优化的经验"><a href="#5-谈谈-SQL-优化的经验" class="headerlink" title="5.谈谈 SQL 优化的经验"></a>5.谈谈 SQL 优化的经验</h4><ul>
<li>查询语句无论是使用哪种判断条件 <strong>等于、小于、大于</strong>， <code>WHERE</code> 左侧的条件查询字段不要使用函数或者表达式</li>
<li>使用 <code>EXPLAIN</code> 命令优化你的 SELECT 查询，对于复杂、效率低的 sql 语句，我们通常是使用 explain sql 来分析这条 sql 语句，这样方便我们分析，进行优化。</li>
<li>当你的 SELECT 查询语句只需要使用一条记录时，要使用 <code>LIMIT 1</code></li>
<li>不要直接使用 <code>SELECT *</code>，而应该使用具体需要查询的表字段，因为使用 EXPLAIN 进行分析时，SELECT * 使用的是全表扫描，也就是 <code>type = all</code>。</li>
<li>为搜索字段创建索引</li>
<li><p>选择合适的字段类型，选择标准是 <strong>尽可能小、尽可能定长、尽可能使用整数</strong>。</p>
</li>
<li><p>进行水平切割或者垂直分割</p>
</li>
</ul>
<blockquote>
<p>水平分割：通过建立结构相同的几张表分别存储数据</p>
<p>垂直分割：将经常一起使用的字段放在一个单独的表中，分割后的表记录之间是一一对应关系。</p>
</blockquote>
<h4 id="6-Mysql中有哪几种锁？"><a href="#6-Mysql中有哪几种锁？" class="headerlink" title="6.Mysql中有哪几种锁？"></a>6.<strong>Mysql中有哪几种锁？</strong></h4><ul>
<li>MyISAM支持表锁，InnoDB支持表锁和行锁，默认为行锁</li>
<li>表级锁：开销小，加锁快，<strong>不会出现死锁</strong>。锁定粒度大，发生锁冲突的概率最高，并发量最低</li>
<li>行级锁：开销大，加锁慢，<strong>会出现死锁</strong>。锁力度小，发生锁冲突的概率小，并发度最高</li>
</ul>
<h4 id="7-like查询会用到索引吗？"><a href="#7-like查询会用到索引吗？" class="headerlink" title="7.like查询会用到索引吗？"></a>7.like查询会用到索引吗？</h4><p>分情况：如果是like ‘%keyword’ 这样以%开头则无法使用索引，如果是‘keyword%’则可以使用索引。</p>
<p>索引文件具有 B-Tree 的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引。</p>
<h4 id="8-InnoDB如何实现事务"><a href="#8-InnoDB如何实现事务" class="headerlink" title="8.InnoDB如何实现事务"></a>8.InnoDB如何实现事务</h4><p>事务具有ACID四个特性：ACD三个特性是通过Redo log(重做日志)和Undo log(回滚日志)实现的。隔离性是通过锁来实现的。</p>
<p><strong>Undo log:</strong></p>
<p><strong>当事务对数据库进行修改时，InnoDB会生成对应的undo log；如果事务执行失败或调用了rollback，导致事务需要回滚，便可以利用undo log中的信息将数据回滚到修改之前的样子。</strong></p>
<p>undo log属于逻辑日志，它记录的是sql执行相关的信息。当发生回滚时，InnoDB会根据undo log的内容做与之前相反的工作：对于每个insert，回滚时会执行delete；对于每个delete，回滚时会执行insert；对于每个update，回滚时会执行一个相反的update，把数据改回去。</p>
<p><strong>Undo log 的用途</strong></p>
<p>（1）保证事务进行rollback时的原子性和一致性，当事务进行回滚的时候可以用undo log的数据进行恢复。</p>
<p>（2）用于MVCC<strong>快照读</strong>的数据，在MVCC多版本控制中，通过读取undo log的历史版本数据可以实现不同事务版本号都拥有自己独立的快照数据版本。</p>
<p><strong>Redo log</strong>（先写log，再写缓存，保证宕机时，缓存数据丢失也无所谓）</p>
<p>读写数据时，先从Buffer Pool读写（如果没有，磁盘读入放入Buffer Pool），Buffer Pool中修改的数据会定期刷新到磁盘中。</p>
<p>问题：如果MySQL宕机，而此时Buffer Pool中修改的数据还没有刷新到磁盘中，导致数据丢失，事务的持久性无法保证。</p>
<p>于是引入Redo log：当数据修改时，除了修改Buffer Pool中的数据，还会在redo log记录这次操作；当事务提交时，会调用fsync接口对redo log进行刷盘。如果MySQL宕机，重启时可以读取redo log中的数据，对数据库进行恢复。redo log采用的是WAL（Write-ahead logging，预写式日志），所有修改先写入日志，再更新到Buffer Pool，保证了数据不会因MySQL宕机而丢失，从而满足了持久性要求。</p>
<h4 id="9-MVCC是通过什么实现多版本控制的"><a href="#9-MVCC是通过什么实现多版本控制的" class="headerlink" title="9.MVCC是通过什么实现多版本控制的"></a>9.MVCC是通过什么实现多版本控制的</h4><p>MVCC是在并发访问数据库时，通过对数据做多版本管理，避免因为写锁的阻塞而造成读数据的并发阻塞问题。</p>
<p>通俗的讲就是MVCC通过保存数据的历史版本，根据比较版本号来处理数据的是否显示，从而达到读取数据的时候不需要加锁就可以保证事务隔离性的效果。</p>
<p><strong>基本特征</strong></p>
<ul>
<li>每行数据都存在一个版本，每次数据更新时都更新该版本。</li>
<li>修改时Copy出当前版本随意修改，各个事务之间无干扰。</li>
<li>保存时比较版本号，如果成功（commit），则覆盖原记录；失败则放弃copy（rollback）</li>
</ul>
<p><strong>隐藏列</strong></p>
<p><strong>DB_TRX_ID:</strong> 记录操作该数据事务的事务ID；</p>
<p><strong>DB_ROLL_PTR：</strong>指向上一个版本数据在undo log 里的位置指针；可以读取undo log的历史版本数据。</p>
<p><strong>DB_ROW_ID:</strong> 隐藏ID ，当创建表没有合适的索引作为聚集索引时，会用该隐藏ID创建聚集索引;（主要是前面两个，这个和MVCC没啥关系）</p>
<p><strong>InnoDB存储引擎MVCC的实现策略</strong></p>
<p>在每一行数据中额外保存两个隐藏的列：当前行创建时的版本号和删除时的版本号（可能为空，其实还有一列称为回滚指针，用于事务回滚，不在本文范畴）。这里的版本号并不是实际的时间值，而是系统版本号。每开始新的事务，系统版本号都会自动递增。事务开始时刻的系统版本号会作为事务的版本号，用来和查询每行记录的版本号进行比较。</p>
<p>每个事务又有自己的版本号，这样事务内执行CRUD操作时，就通过版本号的比较来达到数据版本控制的目的。如何解决不可重复读</p>
<p>1.悲观锁：读取到数据后，就将这些数据加锁。其他事务无法修改这些数据，就可以实现可重复读了。无法锁住insert,无法避免幻读。</p>
<p>2.乐观锁：MVCC</p>
<h4 id="10-order-by会使用索引吗？"><a href="#10-order-by会使用索引吗？" class="headerlink" title="10.order by会使用索引吗？"></a>10.order by会使用索引吗？</h4><p>不一定。</p>
<p>1、ORDER BY的索引优化。如果一个SQL语句形如：<br>SELECT [column1],[column2],…. FROM [TABLE] ORDER BY [sort];<br>在[sort]这个栏位上建立索引就可以实现利用索引进行order by 优化。</p>
<p>2、WHERE + ORDER BY的索引优化，形如：<br>SELECT [column1],[column2],…. FROM [TABLE] WHERE [columnX] = [value] ORDER BY [sort];<br>建立一个联合索引(columnX,sort)来实现order by 优化。</p>
<p>MySQL Order By不能使用索引来优化排序的情况</p>
<p>1.对不同的索引键做 ORDER BY ：(key1,key2分别建立索引)<br>SELECT * FROM t1 ORDER BY key1, key2;</p>
<p>2.用于搜索记录的索引键和做 ORDER BY 的不是同一个：(key1,key2分别建立索引)<br>SELECT * FROM t1 WHERE key2=constant ORDER BY key1;</p>
<p>特别提示:<br>1&gt;mysql一次查询只能使用一个索引。如果要对多个字段使用索引，建立复合索引。<br>2&gt;在ORDER BY操作中，MySQL只有在排序条件不是一个查询条件表达式的情况下才使用索引。</p>
<h4 id="11-联合索引（A-B-where-B-b-and-A-a会使用索引吗"><a href="#11-联合索引（A-B-where-B-b-and-A-a会使用索引吗" class="headerlink" title="11.联合索引（A,B) where B=b and A=a会使用索引吗"></a>11.联合索引（A,B) where B=b and A=a会使用索引吗</h4><p>会，MySQL有优化器会自动调整a，b的顺序与索引一致。</p>
<h4 id="12-Mysql编码utf-8和gbk的区别"><a href="#12-Mysql编码utf-8和gbk的区别" class="headerlink" title="12.Mysql编码utf-8和gbk的区别"></a>12.Mysql编码utf-8和gbk的区别</h4><p>UTF8编码格式很强大，支持所有国家的语言，正是因为它的强大，才会导致它占用的空间大小要比GBK大，对于网站打开速度而言，也是有一定影响的。</p>
<p>GBK编码格式，它的功能少，仅限于中文字符，当然它所占用的空间大小会随着它的功能而减少，打开网页的速度比较快。</p>
<p>UTF8中文占用3个字节，GBK中文占用2个字节，其他的都占一个字节</p>
<h4 id="13-MVCC和锁的关系，为什么有了MVCC还要锁？"><a href="#13-MVCC和锁的关系，为什么有了MVCC还要锁？" class="headerlink" title="13.MVCC和锁的关系，为什么有了MVCC还要锁？"></a>13.MVCC和锁的关系，为什么有了MVCC还要锁？</h4><p>锁：悲观锁，乐观锁，读写锁。MVCC，大部分都是读操作，不需要加读锁，效率更高。</p>
<h4 id="14-MySQL的主从复制"><a href="#14-MySQL的主从复制" class="headerlink" title="14.MySQL的主从复制"></a>14.MySQL的主从复制</h4><p>主库将变更写入 <strong>binlog 日志</strong>，然后从库连接到主库之后，从库有一个 IO 线程，将主库的 binlog 日志拷贝到自己本地，写入一个 relay 中继日志中。接着从库中有一个 SQL 线程会从中继日志读取 binlog，然后执行 binlog 日志中的内容，也就是在自己本地再次执行一遍 SQL，这样就可以保证自己跟主库的数据是一样的。</p>
<p><strong>从库有两个线程：IO线程用来读取主数据库的binlog，SQL线程读取binlog，并执行一遍SQL</strong></p>
<p><img src="https://raw.githubusercontent.com/hac135/my_images/master/20210319_DataStructure_MySQL_masterSlave.jpg" alt="主从复制"></p>

      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/01/相册更新/" rel="next" title="相册更新">
                <i class="fa fa-chevron-left"></i> 相册更新
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/03/19/JVM/" rel="prev" title="JVM">
                JVM <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/mycat.jpg" alt="liuminggui">
            
              <p class="site-author-name" itemprop="name">liuminggui</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">46</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:1406654070@qq.com" title="E-Mail &rarr; mailto:1406654070@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/FFWFWFWE" title="Weibo &rarr; https://weibo.com/FFWFWFWE" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/hac135" title="Github &rarr; https://github.com/hac135" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>Github</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://zhihu.com/people/hac123" title="Zhihu &rarr; https://zhihu.com/people/hac123" rel="noopener" target="_blank"><i class="fa fa-fw fa-battery-half"></i>Zhihu</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://noth1n9.com/" title="http://noth1n9.com/" rel="noopener" target="_blank">邵华哥</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://sigmoid.top/" title="http://sigmoid.top/" rel="noopener" target="_blank">胡哥</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://syncdev.top/" title="http://syncdev.top/" rel="noopener" target="_blank">煌彬哥</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://space.bilibili.com/232524593/" title="https://space.bilibili.com/232524593/" rel="noopener" target="_blank">猛神</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#MyISAM和InnoDB区别"><span class="nav-number">1.</span> <span class="nav-text">MyISAM和InnoDB区别</span></a></li></ol><li class="nav-item nav-level-3"><a class="nav-link" href="#锁机制与InnoDB锁算法"><span class="nav-number"></span> <span class="nav-text">锁机制与InnoDB锁算法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#记录锁（Record-Lock）"><span class="nav-number">1.</span> <span class="nav-text">记录锁（Record Lock）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#间隙锁（Gap-Lock）"><span class="nav-number">2.</span> <span class="nav-text">间隙锁（Gap Lock）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Next-Key-Lock"><span class="nav-number">3.</span> <span class="nav-text">Next-Key Lock</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#大表优化"><span class="nav-number"></span> <span class="nav-text">大表优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-限定数据的范围"><span class="nav-number">1.</span> <span class="nav-text">1. 限定数据的范围</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-读-写分离"><span class="nav-number">2.</span> <span class="nav-text">2. 读/写分离</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-垂直分区"><span class="nav-number">3.</span> <span class="nav-text">3. 垂直分区</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-水平分区"><span class="nav-number">4.</span> <span class="nav-text">4. 水平分区</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分库分表之后-id-主键如何处理？"><span class="nav-number"></span> <span class="nav-text">分库分表之后,id 主键如何处理？</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#索引"><span class="nav-number"></span> <span class="nav-text">索引</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Mysql索引主要使用的两种数据结构"><span class="nav-number"></span> <span class="nav-text">Mysql索引主要使用的两种数据结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#哈希索引-O-1"><span class="nav-number"></span> <span class="nav-text">哈希索引  O(1)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BTree索引-和-B-Tree索引"><span class="nav-number"></span> <span class="nav-text">BTree索引  和 B+Tree索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#面试官：为什么MySQL的索引要使用B-树，而不是其它树？比如B树？"><span class="nav-number">1.</span> <span class="nav-text">面试官：为什么MySQL的索引要使用B+树，而不是其它树？比如B树？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#聚集索引与非聚集索引"><span class="nav-number"></span> <span class="nav-text">聚集索引与非聚集索引</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#聚集索引"><span class="nav-number"></span> <span class="nav-text">聚集索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#聚集索引的优点"><span class="nav-number">1.</span> <span class="nav-text">聚集索引的优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#聚集索引的缺点"><span class="nav-number">2.</span> <span class="nav-text">聚集索引的缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#非聚集索引"><span class="nav-number"></span> <span class="nav-text">非聚集索引</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#非聚集索引的优点"><span class="nav-number">1.</span> <span class="nav-text">非聚集索引的优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#非聚集索引的缺点"><span class="nav-number">2.</span> <span class="nav-text">非聚集索引的缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#非聚集索引一定回表查询吗-覆盖索引"><span class="nav-number"></span> <span class="nav-text">非聚集索引一定回表查询吗(覆盖索引)?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#覆盖索引介绍"><span class="nav-number"></span> <span class="nav-text">覆盖索引介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是覆盖索引"><span class="nav-number"></span> <span class="nav-text">什么是覆盖索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#覆盖索引使用实例"><span class="nav-number"></span> <span class="nav-text">覆盖索引使用实例</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#联合索引最左前缀匹配原则"><span class="nav-number"></span> <span class="nav-text">联合索引最左前缀匹配原则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#联合索引"><span class="nav-number"></span> <span class="nav-text">联合索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最左匹配原则"><span class="nav-number"></span> <span class="nav-text">最左匹配原则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL查询优化"><span class="nav-number"></span> <span class="nav-text">MySQL查询优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用-Explain-进行分析"><span class="nav-number"></span> <span class="nav-text">使用 Explain 进行分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化数据访问"><span class="nav-number"></span> <span class="nav-text">优化数据访问</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-减少请求的数据量"><span class="nav-number">1.</span> <span class="nav-text">1. 减少请求的数据量</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-减少服务器端扫描的行数"><span class="nav-number">2.</span> <span class="nav-text">2. 减少服务器端扫描的行数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重构查询方式"><span class="nav-number"></span> <span class="nav-text">重构查询方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-切分大查询"><span class="nav-number">1.</span> <span class="nav-text">1. 切分大查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-分解大连接查询"><span class="nav-number">2.</span> <span class="nav-text">2. 分解大连接查询</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#数据库常问面试题"><span class="nav-number"></span> <span class="nav-text">数据库常问面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-三大范式"><span class="nav-number">1.</span> <span class="nav-text">1.三大范式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-内连接-自然连接-外连接-笛卡尔连接"><span class="nav-number">2.</span> <span class="nav-text">2.内连接 自然连接 外连接 笛卡尔连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-视图"><span class="nav-number">3.</span> <span class="nav-text">3.视图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-CHAR和VARCHAR的区别"><span class="nav-number">4.</span> <span class="nav-text">4.CHAR和VARCHAR的区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-谈谈-SQL-优化的经验"><span class="nav-number">5.</span> <span class="nav-text">5.谈谈 SQL 优化的经验</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-Mysql中有哪几种锁？"><span class="nav-number">6.</span> <span class="nav-text">6.Mysql中有哪几种锁？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-like查询会用到索引吗？"><span class="nav-number">7.</span> <span class="nav-text">7.like查询会用到索引吗？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#8-InnoDB如何实现事务"><span class="nav-number">8.</span> <span class="nav-text">8.InnoDB如何实现事务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#9-MVCC是通过什么实现多版本控制的"><span class="nav-number">9.</span> <span class="nav-text">9.MVCC是通过什么实现多版本控制的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#10-order-by会使用索引吗？"><span class="nav-number">10.</span> <span class="nav-text">10.order by会使用索引吗？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#11-联合索引（A-B-where-B-b-and-A-a会使用索引吗"><span class="nav-number">11.</span> <span class="nav-text">11.联合索引（A,B) where B=b and A=a会使用索引吗</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#12-Mysql编码utf-8和gbk的区别"><span class="nav-number">12.</span> <span class="nav-text">12.Mysql编码utf-8和gbk的区别</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#13-MVCC和锁的关系，为什么有了MVCC还要锁？"><span class="nav-number">13.</span> <span class="nav-text">13.MVCC和锁的关系，为什么有了MVCC还要锁？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#14-MySQL的主从复制"><span class="nav-number">14.</span> <span class="nav-text">14.MySQL的主从复制</span></a></li></ol></li></ol></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">liuminggui</span>

  

  
  <br>
  <div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>
</div>









        








        
      </div>
	  <script src="http://hac135.github.io/live2d-widget/autoload.js"></script>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>







  






  















  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-beta.2/lazyload.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.3.5/jquery.fancybox.min.js"></script>
  


  




  <script type="text/javascript" src="/js/src/utils.js?v="></script>

  <script type="text/javascript" src="/js/src/motion.js?v="></script>


  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.5.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.5.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.5.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.5.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.5.0"></script>



  



  










  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'dabf16486e15eee437bb',
          clientSecret: 'b43b6f74919a9b657aba14efe129792e9c636f3a',
          repo: 'hac135.github.io',
          owner: 'hac135',
          admin: ['hac135'],
          id: md5(window.location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')
       </script>

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  
  

  

  

  

  

  

  

  



</body>
</html>
  <script type="text/javascript" src="https://unpkg.com/minigrid@3.1.1/dist/minigrid.min.js"></script>
  
  

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>



